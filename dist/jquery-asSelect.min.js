/*! jquery asSelect - v0.1.1 - 2014-08-06
* https://github.com/amazingSurge/jquery-asSelect
* Copyright (c) 2014 amazingSurge; Licensed MIT */
!function(a){var b=a.asSelect=function(c,d){this.element=c,this.$select=a(c);var e=[];a.each(this.$select.data(),function(a,b){var c=new RegExp("^asSelect","i");c.test(a)&&(e[a.toLowerCase().replace(c,"")]=b)}),this.options=a.extend(!0,{},b.defaults,d,e),this.namespace=this.options.namespace,this.classes={wrapper:this.namespace+"-wrapper",old:this.namespace+"-old",dropdown:this.namespace+"-dropdown",trigger:this.namespace+"-trigger",label:this.namespace+"-label",handler:this.namespace+"-handler",item:this.namespace+"-item",group:this.namespace+"-group",mask:this.namespace+"-mask",skin:this.namespace+"_"+this.options.skin,open:this.namespace+"_open",disabled:this.namespace+"_disabled",selected:this.namespace+"_selected",focus:this.namespace+"_focus",loading:this.namespace+"_loading",error:this.namespace+"_error"},this.opened=!1,this.eventBinded=!1,this.inFocus=!0,this.currentIndex=this.options.select,this.isScroll=!1,this.last=0,this.disabled=!1,this.initialized=!1,this._trigger("init"),this.init()};b.prototype={constructor:b,instances:[],init:function(){this.$wrapper=this.$select.wrap('<div class="'+this.classes.wrapper+'"><div class="'+this.classes.old+'" ></div></div>').parent().parent(),this.$trigger=a('<div class="'+this.classes.trigger+'"><div class="'+this.classes.handler+'"></div></div>'),this.$label=a('<div class="'+this.classes.label+'">'+this.options.render.label()+"</div>").prependTo(this.$trigger),this.$dropdown=a('<div class="'+this.classes.dropdown+'"><ul></ul></div>'),this.$ul=this.$dropdown.children("ul"),this.$options=this.$select.find("option"),this.options.skin&&this.$wrapper.addClass(this.classes.skin),this.$select.prop("disabled")&&this.disable(),this.unChooseText=this.$label.text(),this.$dropdown.css("maxHeight",this.options.maxHeight),this.data=this.parse(this.$select.children()),this.update(!0),this.$wrapper.append(this.$trigger).append(this.$dropdown),this.attachInitEvent(),this.options.preload&&this.onLoad(),this.instances.push(this),this.initialized=!0,this._trigger("ready")},_trigger:function(a){this.$select.trigger("asSelect::"+a,this),a=a.replace(/\b\w+\b/g,function(a){return a.substring(0,1).toUpperCase()+a.substring(1)});var b="on"+a,c=arguments.length>1?Array.prototype.slice.call(arguments,1):void 0;"function"==typeof this.options[b]&&this.options[b].apply(this,c)},onLoad:function(){var a=this,b=a.options.load;b&&a.load(function(c){b.apply(a,[c])})},load:function(a){var b=this;b.$wrapper.addClass(b.classes.loading),b.loading++,a.apply(b,[function(a){b.loading=Math.max(b.loading-1,0),a&&a.length&&b.addData(a),b.loading||b.$wrapper.removeClass("loading"),b._trigger("load",a)}])},render:function(b){var c="",d=this,e=function(a){return'<li class="'+d.classes.item+'">'+d.options.render.option.call(d,a)+"</li>"};a.each(b,function(b,f){f.group?(c+='<li class="'+d.classes.group+'">',c+='<div class="'+d.namespace+'-group-label">'+d.options.render.group.call(d,f)+"</div>",c+="<ul>",a.isArray(f.options)&&a.each(f.options,function(a,b){c+=e(b)}),c+="</ul>",c+="</li>"):c+=e(f)}),d.$ul.html(c)},freshOptions:function(b){var c=this,d="",e=function(a){return'<option value="'+a.value+'">'+a.text+"</option>"};a.isArray(b)&&a.each(b,function(b,c){c.group?(d+='<optgroup label="'+c.label+'">',a.isArray(c.options)&&a.each(c.options,function(a,b){d+=e(b)}),d+="</optgroup>"):d+=e(c)}),c.$select.html(d)},parse:function(b){var c=this,d=[],e=function(){return a.extend({},a(this).data(),{value:this.value,text:this.text,slug:c.replaceDiacritics(this.text)})};return b.each(function(){if("optgroup"===this.tagName.toLowerCase()){var b=a.extend({},a(this).data(),{group:!0,label:this.label,options:[]});a(this).children().each(function(){b.options.push(e.call(this))}),d.push(b)}else d.push(e.call(this))}),this.$options.each(function(b,d){a(d).prop("selected")&&(c.currentIndex=b)}),d},update:function(a){this.render(this.data),a&&this.freshOptions(this.data),this.$items=this.$dropdown.find("."+this.classes.item),this.$options=this.$select.find("option"),this.total=this.$items.length,this.last=0,this.initialized&&(this.currentIndex=0),this.$wrapper.removeClass(this.classes.error),this.isScroll=this.$dropdown.height()>this.$ul.outerHeight()?!0:!1,this.currentIndex>=0?this._set(this.currentIndex):this.$label.text(this.unChooseText)},select:function(a){"number"==typeof a&&a>=0&&(this.isScroll&&this.scrollToVisibility(a),this._set(a))},_set:function(b){var c=this.$items[b],d=a(c);this.last=this.currentIndex,this.currentIndex=b,this.$label.text(d.text()),this.$options.length&&a(this.$options[b]).prop("selected",!0),this.$items.removeClass(this.classes.selected),d.addClass(this.classes.selected),this.last!==this.currentIndex&&this._trigger("change",this.getCurrentData(b))},getCurrentData:function(b){var c=0,d=null;return a.each(this.data,function(e,f){f.group?a.isArray(f.options)&&a.each(f.options,function(a,e){c++,b+1===c&&(d=e)}):(c++,b+1===c&&(d=f))}),d},getCurrentIndex:function(b){var c=0;return index=0,a.each(this.data,function(d,e){e.group?a.isArray(e.options)&&a.each(e.options,function(a,d){d.value===b&&(index=c),c++}):(e.value===b&&(index=c),c++)}),index},get:function(){return this.getCurrentData(this.currentIndex).value},replaceDiacritics:function(a){var b,c="40-46 50-53 54-57 62-70 71-74 61 47 77".replace(/\d+/g,"\\3$&").split(" ");for(b in c)a=a.toLowerCase().replace(RegExp("["+c[b]+"]","g"),"aeiouncy".charAt(b));return a},position:function(){var b,c=this.$trigger.outerHeight(!0),d=this.$trigger.offset(),e=this.$dropdown.outerHeight(!0);b=e+d.top>a(window).height()+a(window).scrollTop()?-e-parseInt(this.options.offset[0],10):c+parseInt(this.options.offset[0],10),this.$dropdown.css({top:b})},attachInitEvent:function(){var b=this;"hover"===this.options.trigger?(this.$trigger.on("mouseenter.asSelect",function(){b.open()}),this.$wrapper.on("mouseleave.asSelect",function(){return b.close(),!1})):this.$trigger.on("click.asSelect",function(){b.opened?b.close():b.open()}),this.$select.on("focus.asSelect",function(){b.$wrapper.addClass(b.classes.focus),b.inFocus=!0}).on("blur",function(){b.$wrapper.removeClass(b.classes.focus),b.inFocus=!1}),this.$dropdown.on("click.asSelect","."+this.classes.item,function(){var c=b.$items.index(a(this));b.select(c),b.close()})},dettachInitEvents:function(){this.$trigger.off(".asSelect"),this.$wrap.off(".asSelect"),this.$select.off(".asSelect"),this.$dropdown.off(".asSelect")},keyboardEvent:function(){var b=this;a(document).on("keydown.asSelect",function(a){var c=a.which||a.keycode;if(/^(9|13|27)$/.test(c))return b.close(),!1;if(37>c||c>40)b.isScroll&&b.search.call(b,c);else if(/^(38|40)$/.test(c)){var d=38===c?"up":"down";return b.navigate(d),!1}})},search:function(b){var c,d="";clearTimeout(this.timeout),d=RegExp("^"+(d+=String.fromCharCode(b)),"i"),this.timeout=setTimeout(function(){d=""},16),a.each(this.$items,function(b,e){var f=a.trim(a(e).text());return d.test(f)?(c=b,!1):void 0}),c>=0&&this.select(c)},scrollToVisibility:function(b){var c,d=this.$items[b],e=a(d).outerHeight(),f=this.$dropdown.scrollTop(),g=f+this.$dropdown.height(),h=a(d).position().top;if(f>h)c=h;else{if(!(h>g-e))return;c=h+e-this.$dropdown.height()}this.$dropdown.scrollTop(c)},navigate:function(a){var b=this.total,c=this.currentIndex<0?0:this.currentIndex;c="up"===a?0>=c?b-1:c-1:c>=b-1?0:c+1,this.select(c)},_generateMask:function(){var b=this;"hover"!==this.options.trigger&&(this.$mask=a('<div class="'+this.classes.mask+'"></div>').appendTo(this.$wrapper),this.$mask.on("click.asSelect",function(){return b.close(),!1}))},_clearMask:function(){"hover"!==this.options.trigger&&(this.$mask.off("click.asSelect"),this.$mask.remove(),this.$mask=null)},open:function(){this.opened||this.disabled||(this.$select.focus(),this.closeAll(),this.$wrapper.addClass(this.classes.open),this._generateMask(),this.keyboardEvent(),this.position(),this._trigger("open"),this.opened=!0)},close:function(){this.$wrapper.removeClass(this.classes.open),this._clearMask(),a(document).off("keydown.select"),this._trigger("close"),this.opened=!1},closeAll:function(){a.each(this.instances,function(a,b){b.opened&&b.close()})},addData:function(b){var c=this;a.isArray(b)&&(a.each(b,function(a,d){d.group||(b[a].slug=c.replaceDiacritics(d.text))}),this.data=this.data.concat(b),this.update())},removeData:function(a){return a},enable:function(){return this.disabled=!1,this.$trigger.removeClass(this.classes.disabled),this},disable:function(){return this.disabled=!0,this.$trigger.addClass(this.classes.disabled),this},destroy:function(){this.dettachInitEvents(),a(document).off(".asSelect"),this.$dropdown.remove(),this.$trigger.remove(),this.$select.unwrap().unwrap()}},b.defaults={namespace:"asSelect",skin:null,trigger:"click",offset:[0,0],json:null,preload:!1,load:null,maxHeight:350,select:void 0,render:{label:function(a){return a?a.text:"Choose one"},option:function(a){return a.text},group:function(a){return a.label}},onChange:function(){}},a.fn.asSelect=function(c){if("string"==typeof c){var d=c,e=arguments.length>1?Array.prototype.slice.call(arguments,1):void 0;return this.each(function(){var b=a.data(this,"asSelect");"function"==typeof b[d]&&b[d].apply(b,e)})}return this.each(function(){a.data(this,"asSelect")||a.data(this,"asSelect",new b(this,c))})}}(jQuery);