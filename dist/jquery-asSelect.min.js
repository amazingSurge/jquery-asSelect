/*! jquery asSelect - v0.1.1 - 2014-03-28
* https://github.com/amazingSurge/jquery-asSelect
* Copyright (c) 2014 amazingSurge; Licensed MIT */
(function(t){var s=t.asSelect=function(e,i){this.element=e,this.$select=t(e);var n=[];t.each(this.$select.data(),function(t,s){var e=RegExp("^asSelect","i");e.test(t)&&(n[t.toLowerCase().replace(e,"")]=s)}),this.options=t.extend(!0,{},s.defaults,i,n),this.namespace=this.options.namespace,this.classes={wrapper:this.namespace+"-wrapper",old:this.namespace+"-old",dropdown:this.namespace+"-dropdown",trigger:this.namespace+"-trigger",label:this.namespace+"-label",handler:this.namespace+"-handler",item:this.namespace+"-item",group:this.namespace+"-group",mask:this.namespace+"-mask",skin:this.namespace+"_"+this.options.skin,open:this.namespace+"_open",disabled:this.namespace+"_disabled",selected:this.namespace+"_selected",focus:this.namespace+"_focus",loading:this.namespace+"_loading",error:this.namespace+"_error"},this.opened=!1,this.eventBinded=!1,this.inFocus=!0,this.currentIndex=this.options.select,this.isScroll=!1,this.last=0,this.disabled=!1,this.initialized=!1,this._trigger("init"),this.init()};s.prototype={constructor:s,instances:[],init:function(){this.$wrapper=this.$select.wrap('<div class="'+this.classes.wrapper+'"><div class="'+this.classes.old+'" ></div></div>').parent().parent(),this.$trigger=t('<div class="'+this.classes.trigger+'"><div class="'+this.classes.handler+'"></div></div>'),this.$label=t('<div class="'+this.classes.label+'">'+this.options.render.label()+"</div>").prependTo(this.$trigger),this.$dropdown=t('<div class="'+this.classes.dropdown+'"><ul></ul></div>'),this.$ul=this.$dropdown.children("ul"),this.$options=this.$select.find("option"),this.options.skin&&this.$wrapper.addClass(this.classes.skin),this.$select.prop("disabled")&&this.disable(),this.unChooseText=this.$label.text(),this.$dropdown.css("maxHeight",this.options.maxHeight),this.data=this.parse(this.$select.children()),this.update(!0),this.$wrapper.append(this.$trigger).append(this.$dropdown),this.attachInitEvent(),this.options.preload&&this.onLoad(),this.instances.push(this),this.initialized=!0,this._trigger("ready")},_trigger:function(t){this.$select.trigger("asSelect::"+t,this),t=t.replace(/\b\w+\b/g,function(t){return t.substring(0,1).toUpperCase()+t.substring(1)});var s="on"+t,e=arguments.length>1?Array.prototype.slice.call(arguments,1):void 0;"function"==typeof this.options[s]&&this.options[s].apply(this,e)},onLoad:function(){var t=this,s=t.options.load;s&&t.load(function(e){s.apply(t,[e])})},load:function(t){var s=this;s.$wrapper.addClass(s.classes.loading),s.loading++,t.apply(s,[function(t){s.loading=Math.max(s.loading-1,0),t&&t.length&&s.addData(t),s.loading||s.$wrapper.removeClass("loading"),s._trigger("load",t)}])},render:function(s){var e="",i=this,n=function(t){return'<li class="'+i.classes.item+'">'+i.options.render.option.call(i,t)+"</li>"};t.each(s,function(s,o){o.group?(e+='<li class="'+i.classes.group+'">',e+='<div class="'+i.namespace+'-group-label">'+i.options.render.group.call(i,o)+"</div>",e+="<ul>",t.isArray(o.options)&&t.each(o.options,function(t,s){e+=n(s)}),e+="</ul>",e+="</li>"):e+=n(o)}),i.$ul.html(e)},freshOptions:function(s){var e=this,i="",n=function(t){return'<option value="'+t.value+'">'+t.text+"</option>"};t.isArray(s)&&t.each(s,function(s,e){e.group?(i+='<optgroup label="'+e.label+'">',t.isArray(e.options)&&t.each(e.options,function(t,s){i+=n(s)}),i+="</optgroup>"):i+=n(e)}),e.$select.html(i)},parse:function(s){var e=this,i=[],n=function(){return t.extend({},t(this).data(),{value:this.value,text:this.text,slug:e.replaceDiacritics(this.text)})};return s.each(function(){if("optgroup"===this.tagName.toLowerCase()){var s=t.extend({},t(this).data(),{group:!0,label:this.label,options:[]});t(this).children().each(function(){s.options.push(n.call(this))}),i.push(s)}else i.push(n.call(this))}),this.$options.each(function(s,i){t(i).prop("selected")&&(e.currentIndex=s)}),i},update:function(t){this.render(this.data),t&&this.freshOptions(this.data),this.$items=this.$dropdown.find("."+this.classes.item),this.$options=this.$select.find("option"),this.total=this.$items.length,this.last=0,this.initialized&&(this.currentIndex=0),this.$wrapper.removeClass(this.classes.error),this.isScroll=this.$dropdown.height()>this.$ul.outerHeight()?!0:!1,this.currentIndex>=0?this._set(this.currentIndex):this.$label.text(this.unChooseText)},select:function(t){"number"==typeof t&&t>=0&&(this.isScroll&&this.scrollToVisibility(t),this._set(t))},_set:function(s){var e=this.$items[s],i=t(e);this.last=this.currentIndex,this.currentIndex=s,this.$label.text(i.text()),this.$options.length&&t(this.$options[s]).prop("selected",!0),this.$items.removeClass(this.classes.selected),i.addClass(this.classes.selected),this.last!==this.currentIndex&&this._trigger("change",this.getCurrentData(s))},getCurrentData:function(s){var e=0,i=null;return t.each(this.data,function(n,o){o.group?t.isArray(o.options)&&t.each(o.options,function(t,n){e++,s+1===e&&(i=n)}):(e++,s+1===e&&(i=o))}),i},replaceDiacritics:function(t){var s,e="40-46 50-53 54-57 62-70 71-74 61 47 77".replace(/\d+/g,"\\3$&").split(" ");for(s in e)t=t.toLowerCase().replace(RegExp("["+e[s]+"]","g"),"aeiouncy".charAt(s));return t},position:function(){var s,e=this.$trigger.outerHeight(!0),i=this.$trigger.offset(),n=this.$dropdown.outerHeight(!0);s=n+i.top>t(window).height()+t(window).scrollTop()?-n-parseInt(this.options.offset[0],10):e+parseInt(this.options.offset[0],10),this.$dropdown.css({top:s})},attachInitEvent:function(){var s=this;"hover"===this.options.trigger?(this.$trigger.on("mouseenter.asSelect",function(){s.open()}),this.$wrapper.on("mouseleave.asSelect",function(){return s.close(),!1})):this.$trigger.on("click.asSelect",function(){s.opened?s.close():s.open()}),this.$select.on("focus.asSelect",function(){s.$wrapper.addClass(s.classes.focus),s.inFocus=!0}).on("blur",function(){s.$wrapper.removeClass(s.classes.focus),s.inFocus=!1}),this.$dropdown.on("click.asSelect","."+this.classes.item,function(){var e=s.$items.index(t(this));s.select(e),s.close()})},dettachInitEvents:function(){this.$trigger.off(".asSelect"),this.$wrap.off(".asSelect"),this.$select.off(".asSelect"),this.$dropdown.off(".asSelect")},keyboardEvent:function(){var s=this;t(document).on("keydown.asSelect",function(t){var e=t.which||t.keycode;if(/^(9|13|27)$/.test(e))return s.close(),!1;if(37>e||e>40)s.isScroll&&s.search.call(s,e);else if(/^(38|40)$/.test(e)){var i=38===e?"up":"down";return s.navigate(i),!1}})},search:function(s){var e,i="";clearTimeout(this.timeout),i=RegExp("^"+(i+=String.fromCharCode(s)),"i"),this.timeout=setTimeout(function(){i=""},16),t.each(this.$items,function(s,n){var o=t.trim(t(n).text());return i.test(o)?(e=s,!1):void 0}),e>=0&&this.select(e)},scrollToVisibility:function(s){var e,i=this.$items[s],n=t(i).outerHeight(),o=this.$dropdown.scrollTop(),a=o+this.$dropdown.height(),r=t(i).position().top;if(o>r)e=r;else{if(!(r>a-n))return;e=r+n-this.$dropdown.height()}this.$dropdown.scrollTop(e)},navigate:function(t){var s=this.total,e=0>this.currentIndex?0:this.currentIndex;e="up"===t?0>=e?s-1:e-1:e>=s-1?0:e+1,this.select(e)},_generateMask:function(){var s=this;"hover"!==this.options.trigger&&(this.$mask=t('<div class="'+this.classes.mask+'"></div>').appendTo(this.$wrapper),this.$mask.on("click.asSelect",function(){return s.close(),!1}))},_clearMask:function(){"hover"!==this.options.trigger&&(this.$mask.off("click.asSelect"),this.$mask.remove(),this.$mask=null)},open:function(){this.opened||this.disabled||(this.$select.focus(),this.closeAll(),this.$wrapper.addClass(this.classes.open),this._generateMask(),this.keyboardEvent(),this.position(),this._trigger("open"),this.opened=!0)},close:function(){this.$wrapper.removeClass(this.classes.open),this._clearMask(),t(document).off("keydown.select"),this._trigger("close"),this.opened=!1},closeAll:function(){t.each(this.instances,function(t,s){s.opened&&s.close()})},addData:function(s){var e=this;t.isArray(s)&&(t.each(s,function(t,i){i.group||(s[t].slug=e.replaceDiacritics(i.text))}),this.data=this.data.concat(s),this.update())},removeData:function(t){return t},enable:function(){return this.disabled=!1,this.$trigger.removeClass(this.classes.disabled),this},disable:function(){return this.disabled=!0,this.$trigger.addClass(this.classes.disabled),this},destroy:function(){this.dettachInitEvents(),t(document).off(".asSelect"),this.$dropdown.remove(),this.$trigger.remove(),this.$select.unwrap().unwrap()}},s.defaults={namespace:"asSelect",skin:null,trigger:"click",offset:[0,0],json:null,preload:!1,load:null,maxHeight:350,select:void 0,render:{label:function(t){return t?t.text:"Choose one"},option:function(t){return t.text},group:function(t){return t.label}},onChange:function(){}},t.fn.asSelect=function(e){if("string"==typeof e){var i=e,n=arguments.length>1?Array.prototype.slice.call(arguments,1):void 0;return this.each(function(){var s=t.data(this,"asSelect");"function"==typeof s[i]&&s[i].apply(s,n)})}return this.each(function(){t.data(this,"asSelect")||t.data(this,"asSelect",new s(this,e))})}})(jQuery);